<!DOCTYPE html>
<html>
<head>
  <link rel='stylesheet' href='qunit/qunit.css' type='text/css'/>
  <script type='text/javascript' src='../editor/jquery.js'></script>
  <script type='text/javascript' src='../editor/browser.js'></script>
  <script type='text/javascript' src='../editor/svgutils.js'></script>
  <script type='text/javascript' src='../editor/draw.js'></script>
  <script type='text/javascript' src='qunit/qunit.js'></script>  
  <script type='text/javascript'>
  $(function() {
  	// log function
  	QUnit.log = function(result, message) {
		if (window.console && window.console.log) {
			window.console.log(result +' :: '+ message);
		}
	};

	var SVGNS = 'http://www.w3.org/2000/svg';
	var SENS = "http://svg-edit.googlecode.com";
	var XMLNSNS = "http://www.w3.org/2000/xmlns/";
	var NONCE = 'foo';

	var svg = document.createElementNS(SVGNS, 'svg');

	// Set up <svg> with nonce.
	var svg_n = document.createElementNS(SVGNS, 'svg');
	svg_n.setAttributeNS(XMLNSNS, 'xmlns:se', SENS);
	svg_n.setAttributeNS(SENS, 'se:nonce', NONCE); 

	test('Test draw module', function() {
		expect(4);
		
		ok(svgedit.draw);
		equals(typeof svgedit.draw, typeof {});

		ok(svgedit.draw.Drawing);
		equals(typeof svgedit.draw.Drawing, typeof function(){});
	});
	
	test('Test document creation', function() {
		expect(3);
		
		try {
			var doc = new svgedit.draw.Drawing();
			ok(false, 'Created drawing without a valid <svg> element');
		} catch(e) {
			ok(true);
		}

		try {
			var doc = new svgedit.draw.Drawing(svg);
			ok(doc);
			equals(typeof doc, typeof {});
		} catch(e) {
			ok(false, 'Could not create document from valid <svg> element: ' + e)
		}
	});

	test('Test nonce', function() {
		expect(2);
		
		var doc = new svgedit.draw.Drawing(svg);
		equals(doc.getNonce(), "");

		doc = new svgedit.draw.Drawing(svg_n);
		equals(doc.getNonce(), NONCE);
	});

	test('Test getId() and getNextId() without nonce', function() {
		expect(7);
		
		var elem2 = document.createElementNS(SVGNS, 'circle');
		elem2.id = 'svg_2';
		svg.appendChild(elem2);

		var doc = new svgedit.draw.Drawing(svg);

		equals(doc.getId(), "svg_0");

		equals(doc.getNextId(), "svg_1");
		equals(doc.getId(), "svg_1");

		equals(doc.getNextId(), "svg_3");
		equals(doc.getId(), "svg_3");

		equals(doc.getNextId(), "svg_4");
		equals(doc.getId(), "svg_4");
		
		// clean out svg document
		while(svg.firstChild) {svg.removeChild(svg.firstChild);}
	});

	test('Test getId() and getNextId() with prefix without nonce', function() {
		expect(7);

		var prefix = 'Bar-';
		var doc = new svgedit.draw.Drawing(svg, prefix);

		equals(doc.getId(), prefix+"0");

		equals(doc.getNextId(), prefix+"1");
		equals(doc.getId(), prefix+"1");

		equals(doc.getNextId(), prefix+"2");
		equals(doc.getId(), prefix+"2");

		equals(doc.getNextId(), prefix+"3");
		equals(doc.getId(), prefix+"3");

		while(svg.firstChild) {svg.removeChild(svg.firstChild);}
	});

	test('Test getId() and getNextId() with nonce', function() {
		expect(7);
		
		var prefix = "svg_" + NONCE;

		var elem2 = document.createElementNS(SVGNS, 'circle');
		elem2.id = prefix+'_2';
		svg_n.appendChild(elem2);

		var doc = new svgedit.draw.Drawing(svg_n);

		equals(doc.getId(), prefix+"_0");

		equals(doc.getNextId(), prefix+"_1");
		equals(doc.getId(), prefix+"_1");

		equals(doc.getNextId(), prefix+"_3");
		equals(doc.getId(), prefix+"_3");

		equals(doc.getNextId(), prefix+"_4");
		equals(doc.getId(), prefix+"_4");
		while(svg_n.firstChild) {svg_n.removeChild(svg_n.firstChild);}
	});

	test('Test getId() and getNextId() with prefix with nonce', function() {
		expect(7);

		var PREFIX = 'Bar-';
		var doc = new svgedit.draw.Drawing(svg_n, PREFIX);

		var prefix = PREFIX + NONCE + "_";
		equals(doc.getId(), prefix+"0");

		equals(doc.getNextId(), prefix+"1");
		equals(doc.getId(), prefix+"1");

		equals(doc.getNextId(), prefix+"2");
		equals(doc.getId(), prefix+"2");

		equals(doc.getNextId(), prefix+"3");
		equals(doc.getId(), prefix+"3");

		while(svg_n.firstChild) {svg_n.removeChild(svg_n.firstChild);}
	});
	
	test('Test releaseId()', function() {
		expect(6);

		var doc = new svgedit.draw.Drawing(svg);

		var firstId = doc.getNextId();
		var secondId = doc.getNextId();

		var result = doc.releaseId(firstId);
		ok(result);
		equals(doc.getNextId(), firstId);
		equals(doc.getNextId(), "svg_3");
		
		ok(!doc.releaseId("bad-id"));
		ok(doc.releaseId(firstId));
		ok(!doc.releaseId(firstId));
	});
	
	test('Test getNumLayers', function() {
		expect(2);
		var doc = new svgedit.draw.Drawing(svg);
		equals(typeof doc.getNumLayers, typeof function() {});
		equals(doc.getNumLayers(), 0);
		// TODO(codedread): More here once identifyLayers works.
	});

	test('Test hasLayer', function() {
		expect(2);
		var doc = new svgedit.draw.Drawing(svg);
		equals(typeof doc.hasLayer, typeof function() {});
		ok(!doc.hasLayer('invalid-layer'));
		// TODO(codedread): More here once identifyLayers works.
	});
	
	test('Test identifyLayers() with empty document', function() {
		expect(9);

		var drawing = new svgedit.draw.Drawing(svg);
		
		// By default, an empty document gets an empty group created.
		drawing.identifyLayers();

		// Check that <svg> element now has one child node
		ok(drawing.getSvgElem().hasChildNodes());
		equals(drawing.getSvgElem().childNodes.length, 1);

		// Check that all_layers is correctly set up.
		equals(drawing.getNumLayers(), 1);
		var empty_layer = drawing.all_layers[0][1];
		ok(empty_layer);
		equals(empty_layer, drawing.getSvgElem().firstChild);
		equals(empty_layer.tagName, 'g');
		ok(empty_layer.hasChildNodes());
		equals(empty_layer.childNodes.length, 1);
		var firstChild = empty_layer.childNodes.item(0);
		equals(firstChild.tagName, 'title');

		while(svg.firstChild) {svg.removeChild(svg.firstChild);}
	});
	
	test('Test identifyLayers() with some layers', function() {
		expect(5);
		
		var layer1 = document.createElementNS(SVGNS, 'g');
		var layer1_title = document.createElementNS(SVGNS, 'title');
		layer1_title.appendChild(document.createTextNode('Layer 1'));
		layer1.appendChild(layer1_title);

		var layer2 = document.createElementNS(SVGNS, 'g');
		var layer2_title = document.createElementNS(SVGNS, 'title');
		layer2_title.appendChild(document.createTextNode('Layer 2'));
		layer2.appendChild(layer2_title);

		var layer3 = document.createElementNS(SVGNS, 'g');
		var layer3_title = document.createElementNS(SVGNS, 'title');
		layer3_title.appendChild(document.createTextNode('Layer 3'));
		layer3.appendChild(layer3_title);
		
		svg.appendChild(layer1);
		svg.appendChild(layer2);
		svg.appendChild(layer3);
		equals(svg.childNodes.length, 3);
		
		var drawing = new svgedit.draw.Drawing(svg);
		drawing.identifyLayers();
		
		equals(drawing.getNumLayers(), 3);
		equals(drawing.all_layers[0][1], svg.childNodes.item(0));
		equals(drawing.all_layers[1][1], svg.childNodes.item(1));
		equals(drawing.all_layers[2][1], svg.childNodes.item(2));

		while(svg.firstChild) {svg.removeChild(svg.firstChild);}
	});

	test('Test identifyLayers() with some layers and orphans', function() {
		expect(9);
		
		var layer1 = document.createElementNS(SVGNS, 'g');
		var layer1_title = document.createElementNS(SVGNS, 'title');
		layer1_title.appendChild(document.createTextNode('Layer 1'));
		layer1.appendChild(layer1_title);
		svg.appendChild(layer1);

		var layer2 = document.createElementNS(SVGNS, 'g');
		var layer2_title = document.createElementNS(SVGNS, 'title');
		layer2_title.appendChild(document.createTextNode('Layer 2'));
		layer2.appendChild(layer2_title);
		svg.appendChild(layer2);

		var orphan1 = document.createElementNS(SVGNS, 'rect');
		var orphan2 = document.createElementNS(SVGNS, 'rect');
		svg.appendChild(orphan1);
		svg.appendChild(orphan2);
		
		equals(svg.childNodes.length, 4);
		
		var drawing = new svgedit.draw.Drawing(svg);
		drawing.identifyLayers();
		
		equals(drawing.getNumLayers(), 3);
		equals(drawing.all_layers[0][1], svg.childNodes.item(0));
		equals(drawing.all_layers[1][1], svg.childNodes.item(1));
		equals(drawing.all_layers[2][1], svg.childNodes.item(2));
		var layer3 = drawing.all_layers[2][1];
		equals(layer3.tagName, 'g');
		equals(layer3.childNodes.length, 3);
		equals(layer3.childNodes.item(1), orphan1);
		equals(layer3.childNodes.item(2), orphan2);

		while(svg.firstChild) {svg.removeChild(svg.firstChild);}
	});

  });
  </script>
</head>  
<body>  
  <h1 id='qunit-header'>Unit Tests for draw.js</h1>
  <h2 id='qunit-banner'></h2>
  <h2 id='qunit-userAgent'></h2>
  <ol id='qunit-tests'>
  </ol>
  <div id='anchor' style='visibility:hidden'>
  </div>
</body>  
</html>
